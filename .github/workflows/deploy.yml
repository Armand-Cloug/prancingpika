name: Deploy PrancingPika (Traefik + Next + Parser + MariaDB)

on:
  push:
    branches: ["main"]
  workflow_dispatch: {}

concurrency:
  group: production-deploy
  cancel-in-progress: false

env:
  TARGET_BASE: /opt/prancingpika
  TARGET_SRC: /opt/prancingpika/src
  TARGET_DATA: /opt/prancingpika/data

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: Prod

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Check required secrets/vars
        run: |
          set -e
          test -n "${SERVER_HOST}" || (echo "❌ Missing SERVER_HOST" && exit 1)
          test -n "${SERVER_USER}" || (echo "❌ Missing SERVER_USER" && exit 1)
          test -n "${SERVER_SSH_KEY}" || (echo "❌ Missing SERVER_SSH_KEY" && exit 1)

          test -n "${DB_ROOT_PASSWORD}" || (echo "❌ Missing DB_ROOT_PASSWORD" && exit 1)
          test -n "${DB_PASSWORD}" || (echo "❌ Missing DB_PASSWORD" && exit 1)

          test -n "${DOMAIN}" || (echo "❌ Missing vars.DOMAIN" && exit 1)
          test -n "${TRAEFIK_ACME_EMAIL}" || (echo "❌ Missing vars.TRAEFIK_ACME_EMAIL" && exit 1)

          test -n "${NEXTAUTH_URL}" || (echo "❌ Missing vars.NEXTAUTH_URL" && exit 1)
          test -n "${NEXTAUTH_SECRET}" || (echo "❌ Missing NEXTAUTH_SECRET" && exit 1)

          echo "✅ OK"
        env:
          SERVER_HOST: ${{ secrets.SERVER_HOST }}
          SERVER_USER: ${{ secrets.SERVER_USER }}
          SERVER_SSH_KEY: ${{ secrets.SERVER_SSH_KEY }}

          DB_ROOT_PASSWORD: ${{ secrets.DB_ROOT_PASSWORD }}
          DB_PASSWORD: ${{ secrets.DB_PASSWORD }}

          DOMAIN: ${{ vars.DOMAIN }}
          TRAEFIK_ACME_EMAIL: ${{ vars.TRAEFIK_ACME_EMAIL }}

          NEXTAUTH_URL: ${{ vars.NEXTAUTH_URL }}
          NEXTAUTH_SECRET: ${{ secrets.NEXTAUTH_SECRET }}

      - name: Write SSH key file (normalize)
        run: |
          set -e
          mkdir -p ~/.ssh
          echo "${{ secrets.SERVER_SSH_KEY }}" > ~/.ssh/id_ci
          sed -i 's/\r$//' ~/.ssh/id_ci
          chmod 600 ~/.ssh/id_ci
          ssh-keygen -y -f ~/.ssh/id_ci > /dev/null

      - name: Sanity SSH
        run: |
          ssh -o StrictHostKeyChecking=accept-new -i ~/.ssh/id_ci \
            ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} \
            "echo OK && whoami && hostname && sudo -n /usr/bin/docker version >/dev/null && echo SUDO_OK"

      - name: Prepare /opt target dirs + preserve acme.json
        uses: appleboy/ssh-action@v0.1.10
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          script: |
            set -euo pipefail

            BASE="${{ env.TARGET_BASE }}"
            SRC="${{ env.TARGET_SRC }}"
            DATA="${{ env.TARGET_DATA }}"

            # Create /opt structure (sudo ok)
            sudo mkdir -p "${SRC}" "${DATA}"
            sudo chown -R "$USER":"$USER" "${BASE}" || true

            # backup acme.json -> DATA
            if [ -f "${SRC}/traefik/acme.json" ]; then
              mkdir -p "${DATA}/traefik"
              cp "${SRC}/traefik/acme.json" "${DATA}/traefik/acme.json"
              chmod 600 "${DATA}/traefik/acme.json" || true
            fi

            # clean SRC
            rm -rf "${SRC:?}/"* "${SRC}"/.[!.]* "${SRC}"/..?* || true

            # restore acme.json
            mkdir -p "${SRC}/traefik"
            if [ -f "${DATA}/traefik/acme.json" ]; then
              cp "${DATA}/traefik/acme.json" "${SRC}/traefik/acme.json"
              chmod 600 "${SRC}/traefik/acme.json" || true
            fi

      - name: Upload project to server (/opt/prancingpika/src)
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          source: "./*"
          target: "${{ env.TARGET_SRC }}"
          overwrite: true
          timeout: 240s

      - name: Deploy (install docker if needed, write envs, compose up)
        uses: appleboy/ssh-action@v0.1.10
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          script: |
            set -euo pipefail

            SRC="${{ env.TARGET_SRC }}"
            DATA="${{ env.TARGET_DATA }}"

            echo "[1/7] Install Docker if needed"
            if ! command -v docker >/dev/null 2>&1; then
              sudo apt-get update -y
              sudo apt-get install -y ca-certificates curl gnupg
              sudo install -m 0755 -d /etc/apt/keyrings
              curl -fsSL https://download.docker.com/linux/debian/gpg | sudo gpg --dearmor -o /etc/apt/keyrings/docker.gpg
              echo "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/debian $(. /etc/os-release && echo $VERSION_CODENAME) stable" | sudo tee /etc/apt/sources.list.d/docker.list >/dev/null
              sudo apt-get update -y
              sudo apt-get install -y docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin
            fi

            echo "[2/7] Go to project"
            cd "${SRC}"

            echo "[3/7] Ensure Traefik acme.json"
            mkdir -p traefik "${DATA}/traefik"
            # prefer persistent acme in DATA
            if [ ! -f "${DATA}/traefik/acme.json" ]; then
              install -m 600 /dev/null "${DATA}/traefik/acme.json" || { touch "${DATA}/traefik/acme.json" && chmod 600 "${DATA}/traefik/acme.json"; }
            else
              chmod 600 "${DATA}/traefik/acme.json"
            fi
            # copy into repo path if your compose mounts ./traefik/acme.json
            cp "${DATA}/traefik/acme.json" traefik/acme.json
            chmod 600 traefik/acme.json

            echo "[4/7] Write ENV files"

            DB_USER="${{ vars.MARIADB_USER }}"
            DB_NAME="${{ vars.MARIADB_DATABASE }}"
            DB_USER="${DB_USER:-ptp_prod}"
            DB_NAME="${DB_NAME:-ptp_prod}"

            # root compose env
            cat > .env <<EOF
            DOMAIN=${{ vars.DOMAIN }}
            TRAEFIK_ACME_EMAIL=${{ vars.TRAEFIK_ACME_EMAIL }}

            DB_ROOT_PASSWORD=${{ secrets.DB_ROOT_PASSWORD }}
            DB_PASSWORD=${{ secrets.DB_PASSWORD }}
            MARIADB_USER=${DB_USER}
            MARIADB_DATABASE=${DB_NAME}

            # Used by Prisma (host=db in docker network)
            DATABASE_URL=mysql://${DB_USER}:${{ secrets.DB_PASSWORD }}@db:3306/${DB_NAME}
            EOF

            # Next env
            mkdir -p app
            cat > app/.env <<EOF
            DATABASE_URL=mysql://${DB_USER}:${{ secrets.DB_PASSWORD }}@db:3306/${DB_NAME}

            NEXTAUTH_URL=${{ vars.NEXTAUTH_URL }}
            NEXTAUTH_SECRET=${{ secrets.NEXTAUTH_SECRET }}
            NEXTAUTH_TRUST_HOST=true
            AUTH_TRUST_HOST=true

            GOOGLE_CLIENT_ID=${{ secrets.GOOGLE_CLIENT_ID }}
            GOOGLE_CLIENT_SECRET=${{ secrets.GOOGLE_CLIENT_SECRET }}

            DISCORD_CLIENT_ID=${{ secrets.DISCORD_CLIENT_ID }}
            DISCORD_CLIENT_SECRET=${{ secrets.DISCORD_CLIENT_SECRET }}

            COMBATLOG_DIR=/data/combat.log
            PARSER_URL=http://parser:8080
            EOF

            # Parser env (if your API reads it; otherwise DATABASE_URL + envs can be enough)
            mkdir -p parser
            cat > parser/.env <<EOF
            DATABASE_URL=mysql://${DB_USER}:${{ secrets.DB_PASSWORD }}@db:3306/${DB_NAME}

            PARSER_WORKDIR=/workspace
            COMBATLOG_DIR=/data/combat.log
            PARSER_TIMEOUT_S=600
            PARSER_ENV_FILE=/workspace/parser/.env
            EOF

            echo "[5/7] Start base services"
            sudo docker compose down || true
            sudo docker compose up -d traefik db

            echo "[5b/7] Wait MariaDB healthy"
            for i in {1..60}; do
              state=$(sudo docker inspect --format='{{json .State.Health.Status}}' mariadb 2>/dev/null || echo "null")
              echo "Health mariadb: $state"
              [ "$state" = "\"healthy\"" ] && break
              sleep 2
            done

            echo "[6/7] Prisma migrate deploy (prod-safe)"
            sudo docker compose run --rm web npx prisma migrate deploy

            echo "[7/7] Build & start services"
            sudo docker compose up -d --build parser web

            sudo docker ps --format 'table {{.Names}}\t{{.Status}}\t{{.Ports}}'
