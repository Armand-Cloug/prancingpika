name: Deploy PrancingPika

on:
  push:
    branches: ["main"]
  workflow_dispatch: {}

concurrency:
  group: production-deploy
  cancel-in-progress: false

env:
  # Emplacement sur le serveur
  TARGET_BASE: /opt/prancingpika
  TARGET_SRC: /opt/prancingpika/src
  TARGET_DATA: /opt/prancingpika/data

  # Nom de projet Docker Compose (Ã©vite les collisions de noms)
  COMPOSE_PROJECT: ptpika

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: Prod

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Check required secrets
        run: |
          set -e
          test -n "${SERVER_HOST}" || (echo "Missing SERVER_HOST" && exit 1)
          test -n "${SERVER_USER}" || (echo "Missing SERVER_USER" && exit 1)
          test -n "${SERVER_SSH_KEY}" || (echo "Missing SERVER_SSH_KEY" && exit 1)
        env:
          SERVER_HOST: ${{ secrets.SERVER_HOST }}
          SERVER_USER: ${{ secrets.SERVER_USER }}
          SERVER_SSH_KEY: ${{ secrets.SERVER_SSH_KEY }}

      - name: Write SSH key file (normalize)
        run: |
          set -e
          mkdir -p ~/.ssh
          echo "${{ secrets.SERVER_SSH_KEY }}" > ~/.ssh/id_ci
          sed -i 's/\r$//' ~/.ssh/id_ci
          chmod 600 ~/.ssh/id_ci
          ssh-keygen -y -f ~/.ssh/id_ci > /dev/null

      - name: Sanity SSH (and sudo NOPASSWD)
        run: |
          ssh -o StrictHostKeyChecking=accept-new -i ~/.ssh/id_ci \
            ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} \
            "echo OK && whoami && hostname && sudo -n true && echo SUDO_OK"

      - name: Prepare target dir (/opt) (persist acme.json)
        uses: appleboy/ssh-action@v0.1.10
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          script: |
            set -euo pipefail

            BASE="${{ env.TARGET_BASE }}"
            SRC="${{ env.TARGET_SRC }}"
            DATA="${{ env.TARGET_DATA }}"

            # /opt structure (needs sudo)
            sudo -n mkdir -p "${SRC}" "${DATA}"
            sudo -n chown -R "$USER":"$USER" "${BASE}" || true

            # Backup ACME to persistent DATA
            if [ -f "${SRC}/traefik/acme.json" ]; then
              mkdir -p "${DATA}/traefik"
              cp "${SRC}/traefik/acme.json" "${DATA}/traefik/acme.json"
              chmod 600 "${DATA}/traefik/acme.json" || true
            fi

            # Clean SRC
            rm -rf "${SRC:?}/"* "${SRC}"/.[!.]* "${SRC}"/..?* || true

            # Restore ACME into SRC (compose expects ./traefik/acme.json)
            mkdir -p "${SRC}/traefik"
            if [ -f "${DATA}/traefik/acme.json" ]; then
              cp "${DATA}/traefik/acme.json" "${SRC}/traefik/acme.json"
              chmod 600 "${SRC}/traefik/acme.json" || true
            else
              # Create empty acme if none exists yet
              install -m 600 /dev/null "${SRC}/traefik/acme.json" || { touch "${SRC}/traefik/acme.json"; chmod 600 "${SRC}/traefik/acme.json"; }
            fi

      - name: Upload project to server (/opt/prancingpika/src)
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          source: "./*"
          target: "${{ env.TARGET_SRC }}"
          overwrite: true
          timeout: 180s

      - name: Provision & Deploy (compose up + migrations)
        uses: appleboy/ssh-action@v0.1.10
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          script: |
            set -euo pipefail

            SRC="${{ env.TARGET_SRC }}"
            DATA="${{ env.TARGET_DATA }}"
            PROJECT="${{ env.COMPOSE_PROJECT }}"

            echo "[1/8] Go to project"
            cd "${SRC}"

            echo "[2/8] Ensure shared networks exist (proxy/internal)"
            sudo -n docker network create proxy >/dev/null 2>&1 || true
            sudo -n docker network create internal >/dev/null 2>&1 || true

            echo "[3/8] Ensure Traefik ACME is persistent"
            sudo -n mkdir -p "${DATA}/traefik"
            if [ ! -f "${DATA}/traefik/acme.json" ]; then
              sudo -n install -m 600 /dev/null "${DATA}/traefik/acme.json" || true
            fi
            sudo -n chmod 600 "${DATA}/traefik/acme.json" || true

            mkdir -p traefik
            cp "${DATA}/traefik/acme.json" traefik/acme.json
            chmod 600 traefik/acme.json || true

            echo "[4/8] Write ENV files"

            # Root .env for compose (includes APP_DOMAIN to avoid warnings)
            rm -f .env
            {
              echo "############################################################"
              echo "# Traefik / Domain"
              echo "############################################################"
              echo "APP_DOMAIN=${{ vars.APP_DOMAIN }}"
              echo "TRAEFIK_ACME_EMAIL=${{ vars.TRAEFIK_ACME_EMAIL }}"
              echo
              echo "############################################################"
              echo "# Database"
              echo "############################################################"
              echo "DATABASE_URL=${{ secrets.DATABASE_URL }}"
              echo "DB_ROOT_PASSWORD=${{ secrets.DB_ROOT_PASSWORD }}"
              echo "DB_PASSWORD=${{ secrets.DB_PASSWORD }}"
              echo "MARIADB_ROOT_PASSWORD=${{ secrets.DB_ROOT_PASSWORD }}"
              echo "MARIADB_PASSWORD=${{ secrets.DB_PASSWORD }}"
              echo "MARIADB_USER=${{ vars.DB_USER }}"
              echo "MARIADB_DATABASE=${{ vars.DB_NAME }}"
              echo
            } >> .env

            # app/.env (Next)
            mkdir -p app
            rm -f app/.env
            {
              echo "DATABASE_URL=${{ secrets.DATABASE_URL }}"
              echo
              echo "NEXTAUTH_URL=${{ vars.NEXTAUTH_URL }}"
              echo "NEXTAUTH_SECRET=${{ secrets.NEXTAUTH_SECRET }}"
              echo "NEXTAUTH_TRUST_HOST=true"
              echo "AUTH_TRUST_HOST=true"
              echo
              echo "GOOGLE_CLIENT_ID=${{ secrets.GOOGLE_CLIENT_ID }}"
              echo "GOOGLE_CLIENT_SECRET=${{ secrets.GOOGLE_CLIENT_SECRET }}"
              echo
              echo "DISCORD_CLIENT_ID=${{ secrets.DISCORD_CLIENT_ID }}"
              echo "DISCORD_CLIENT_SECRET=${{ secrets.DISCORD_CLIENT_SECRET }}"
              echo
              # In docker: use shared volume mount path
              echo "COMBATLOG_DIR=/data/combat.log"
              # Call the parser service by docker DNS name
              echo "PARSER_URL=http://parser:8080"
              echo
            } >> app/.env

            # parser/.env (Python parser)
            mkdir -p parser
            rm -f parser/.env
            {
              echo "DATABASE_URL=${{ secrets.DATABASE_URL }}"
              echo
              echo "PARSER_WORKDIR=/workspace"
              echo "COMBATLOG_DIR=/data/combat.log"
              echo "PARSER_ENV_FILE=/workspace/parser/.env"
              echo "PARSER_TIMEOUT_S=600"
              echo
            } >> parser/.env

            echo "[5/8] Stop previous stack (avoid container name conflicts)"
            sudo -n docker compose -p "$PROJECT" down --remove-orphans || true

            # If your compose uses container_name, force remove known offenders (safe)
            sudo -n docker rm -f ptpika_traefik ptppika_mariadb ptpika_parser ptpika_web >/dev/null 2>&1 || true

            echo "[6/8] Start base services (traefik + db)"
            sudo -n docker compose -p "$PROJECT" up -d traefik db

            echo "[6b/8] Wait MariaDB healthy"
            for i in {1..60}; do
              state=$(sudo -n docker inspect --format='{{json .State.Health.Status}}' "${PROJECT}_db_1" 2>/dev/null || echo "null")
              # fallback if service/container name differs
              [ "$state" = "null" ] && state=$(sudo -n docker inspect --format='{{json .State.Health.Status}}' mariadb 2>/dev/null || echo "null")
              echo "Health db: $state"
              [ "$state" = "\"healthy\"" ] && break
              sleep 2
            done

            echo "[7/8] Prisma migrate deploy"
            sudo -n docker compose -p "$PROJECT" run --rm web npx prisma migrate deploy

            echo "[8/8] Build & start web + parser"
            sudo -n docker compose -p "$PROJECT" up -d --build web parser

            echo "Containers:"
            sudo -n docker ps --format 'table {{.Names}}\t{{.Status}}\t{{.Ports}}'

            echo "Persist ACME back to DATA (best effort)"
            if [ -f "traefik/acme.json" ]; then
              sudo -n cp "traefik/acme.json" "${DATA}/traefik/acme.json" || true
              sudo -n chmod 600 "${DATA}/traefik/acme.json" || true
            fi
