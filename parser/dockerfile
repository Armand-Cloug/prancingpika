# syntax=docker/dockerfile:1
FROM python:3.11-slim

ENV PYTHONDONTWRITEBYTECODE=1 \
    PYTHONUNBUFFERED=1

RUN apt-get update \
  && apt-get install -y --no-install-recommends ca-certificates wget \
  && rm -rf /var/lib/apt/lists/*

WORKDIR /workspace

RUN pip install --no-cache-dir \
    fastapi \
    "uvicorn[standard]" \
    pydantic \
    mysql-connector-python \
    python-dotenv

# Ici, "." = le dossier ./parser (car context=./parser)
COPY . /workspace/parser

RUN useradd -m -u 10001 appuser \
  && chown -R appuser:appuser /workspace
USER appuser

ENV PARSER_WORKDIR=/workspace \
    COMBATLOG_DIR=/data/combat.log \
    PARSER_TIMEOUT_S=600

EXPOSE 8080

CMD ["python", "-m", "uvicorn", "parser.api:app", "--host", "0.0.0.0", "--port", "8080"]
